<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Karma Group Chatbot</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }

      .chatbot-container {
        width: 471px;
        height: 500px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      @media (max-width: 500px) {
        .chatbot-container {
          width: 100%;
          height: 100vh;
          border-radius: 0;
        }
      }

      #contactForm {
        width: 70%;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background-color: #8b6f3d;
        border-bottom: 1px solid #e5e7eb;
      }

      .header h1 {
        font-size: 18px;
        font-weight: 600;
        color: white;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-icon-img {
        width: 15px;
        height: 15px;
        object-fit: contain;
      }

      .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
      }

      .login-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 24px;
        width: 100%;
        height: 100%;
        padding: 16px;
        max-width: 350px;
        margin: 0 auto;
      }

      .form-logo {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 8px;
      }

      .detail-box {
        text-align: center;
      }

      .detail-header {
        color: #8d714c;
        font-weight: 200;
        font-size: 26.47px;
        line-height: 116%;
      }

      .form-group {
        width: 100%;
        position: relative;
        margin-bottom: 24px;
      }

      .form-group input {
        width: 100%;
        padding: 8px 0;
        font-size: 14px;
        border: none;
        border-bottom: 2px solid #8d714c;
        background: transparent;
        transition: border-bottom-color 0.2s;
      }

      .form-group input:focus {
        outline: none;
      }

      .form-group label {
        position: absolute;
        top: 8px;
        left: 0;
        font-size: 14px;
        color: #8d714c;
        transition: all 0.2s ease-out;
        pointer-events: none;
      }

      .form-group input:focus + label,
      .form-group input:not(:placeholder-shown) + label {
        top: -12px;
        font-size: 12px;
        color: #8b6f3d;
        font-weight: 600;
      }

      .submit-btn {
        width: 100%;
        padding: 12px 52px;
        border: none;
        border-radius: 25px;
        background-color: #8d714c;
        color: white;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        letter-spacing: 0.02em;
      }

      .submit-btn:hover {
        background-color: #725a33;
      }

      /* Chat */
      .chat-content {
        display: none;
        flex-direction: column;
        flex: 1;
        padding: 16px 0px;
      }

      .chat-messages-container {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        margin-top: 18%;
      }

      .message {
        display: flex;
        align-items: start;
      }

      .message.user {
        justify-content: flex-end;
        padding: 10px;
      }

      .message.bot {
        justify-content: flex-start;
      }

      .bot-avatar {
        width: 32px;
        height: 32px;
        margin-right: 12px;
        flex-shrink: 0;
        background-color: #8b6f3d;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
      }

      .message-bubble {
        max-width: 70%;
        background: #f7f3e8;
        border-radius: 16px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .message.user .message-bubble {
        background-color: #8b6f3d;
        color: white;
      }

      .message-text {
        font-size: 14px;
        color: #1f2937;
        line-height: 1.4;
      }

      .message.user .message-text {
        color: white;
      }

      .chat-options {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        margin-bottom: 15px;
      }

      .chat-option-btn {
        padding: 8px 16px;
        border: 0.5px solid #b2b2b2;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        background: white;
        color: #b2b2b2;
        transition: background-color 0.2s;
      }

      .chat-option-btn:hover {
        background-color: #f3f4f6;
        background: #f0f0f0;
        border-color: #999;
        color: #000;
        text-decoration: none;
      }

      .chat-footer {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .chat-input-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .chat-input-container {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 3px;
        border-radius: 25px;
        background-color: white;
        border: 1px solid #8d714c29;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .chat-input {
        flex: 1;
        border: none;
        background: white;
        padding: 5px 10px;
        font-size: 14px;
        outline: none;
        color: #1f2937;
      }

      .chat-input::placeholder {
        color: #b2b2b2;
      }

      .chat-mic-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-send-btn {
        background-color: #8d714c;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .resorts-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0px 15px 0px;
        align-items: center;
        justify-content: left;
      }

      .resorts-option-btn {
        padding: 6px 14px;
        border: 1px solid #998363;
        border-radius: 20px;
        background: #f7f3e8;
        color: #333;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .resorts-option-btn:hover {
        background: #8d714c;
        color: #fff;
        border-color: #8d714c;
        text-decoration: none;
      }

      .resort-title {
        color: #333;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
      }

      #resort-main-btns {
        padding-bottom: 10px;
        padding-left: 45px;
      }

      .back-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .back-icon-img {
        width: 15px;
        height: 15px;
        object-fit: contain;
      }

      .message.user {
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(50px);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .typing-indicator {
        display: flex;
        gap: 4px;
        align-items: center;
        margin: 6px 0;
      }

      .typing-indicator span {
        width: 6px;
        height: 6px;
        background: #8b6f3d;
        border-radius: 50%;
        display: inline-block;
        animation: bounce 1.2s infinite;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0.6);
          opacity: 0.6;
        }

        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .message.bot {
        animation: fadeIn 0.4s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-bubble {
        max-width: 80%;
        word-wrap: break-word;
        border-radius: 12px;
      }

      .message-text ul {
        margin: 6px 0 6px 10px;
      }

      .menu-buttons {
        display: flex;
        justify-content: end;
        gap: 12px;
        margin: 12px 10px;
      }

      .menu-btn {
        padding: 10px 18px;
        border: none;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
      }

      .ask-btn {
        background-color: #f7f3e8;
        color: #8b6f3d;
      }

      .ask-btn:hover {
        background-color: #8b6f3d;
        color: #f7f3e8;
      }

      .end-btn {
        background-color: #8b6f3d;
        color: #f7f3e8;
      }

      .end-btn:hover {
        background-color: #f7f3e8;
        color: #333;
      }
    </style>
  </head>

  <body>
    <div class="chatbot-container">
      <header class="header">
        <button
          class="header-btn back-btn"
          onclick="goBackToChat()"
          style="display: none"
        >
          <img src="images/arrow-left.svg" alt="Back" class="back-icon-img" />
        </button>
        <h1>Karma Group</h1>
        <div class="header-actions">
          <button class="header-btn" onclick="closeChat()">
            <img
              src="images/button-closer.svg"
              alt="Close"
              class="close-icon-img"
            />
          </button>
        </div>
      </header>

      <main class="main-content" id="main-content"></main>
    </div>

    <script src="mic-to-text.js"></script>
    <script>
      let resortsList = [];
      let siteLinks = {};

      fetch("final.json")
        .then((res) => res.json())
        .then((data) => {
          siteLinks = data.site_links || {};
          resortsList = data.resorts || [];
        })
        .catch((err) => console.error("Error loading JSON:", err));
    </script>

    <script>
      let currentPage = "login";
      let userName = "";
      let messages = [];
      let currentResort = null;
      let currentStep = "resort";
      let activeFlow = null;
      let idleTimer;
      let waitingForUser = false;

      const OTHERS_LABEL = "Others";
      const OTHERS_LINK = "https://karmaclub.karmagroup.com/member/offers/";
      const MORE_OPTIONS_LABEL = "More options";

      const mainContent = document.getElementById("main-content");
      const NAME_KEY = "kg_chat_name";

      function clearChatStorage() {
        try {
          localStorage.removeItem(NAME_KEY);
        } catch {}
      }

      function resetFlow() {
        currentResort = null;
        currentStep = "resort";
        activeFlow = null;
      }

      function createOthersButton() {
        const btn = document.createElement("button");
        btn.className = "resorts-option-btn";
        btn.textContent = OTHERS_LABEL;
        btn.addEventListener("click", () => showOthersInfo());
        return btn;
      }
      function toggleChatFooter(show) {
        const f = document.getElementById("chat-footer");
        if (f) f.style.display = show ? "block" : "none";
      }

      function showOthersInfo() {
        const html = `
    <strong style="color:#8b6f3d;">${OTHERS_LABEL}</strong><br>
    <p>For more details please go to the link below:</p>
    <p><a href="${OTHERS_LINK}" target="_blank" rel="noopener">Open link</a></p>
  `;
        addMessage("bot", html);
      }

      function scrollChatToBottom() {
        const mainContent = document.getElementById("main-content");
        if (mainContent) {
          mainContent.scrollTop = mainContent.scrollHeight;
        }
      }

      function closeChat() {
        clearChatStorage();
        userName = "";
        messages = [];
        resetFlow();
        currentPage = "login";
        document.querySelector(".chatbot-container").style.display = "none";
      }

      function scrollSoon() {
        requestAnimationFrame(() => {
          requestAnimationFrame(scrollChatToBottom);
        });
      }
      function openChat() {
        const container = document.querySelector(".chatbot-container");
        container.style.display = "flex";
        currentPage = "login";
        renderApp();
      }
      window.openChat = openChat;

      function renderLoginForm() {
        mainContent.innerHTML = `
        <div class="login-content">
          <div class="form-logo"> 
            <img src="images/header-bot.svg" alt="Bot">
          </div>
          <div class="detail-box">
            <h2 class="detail-header">Please fill your details</h2>
          </div>
          <form id="contactForm">
            <div class="form-group">
              <input type="text" id="name" name="name" placeholder=" " required autocomplete="name">
              <label for="name">Name</label>
            </div>
            <div class="form-group">
              <input type="email" id="email" name="email" placeholder=" " required autocomplete="email">
              <label for="email">Email</label>
            </div>
            <div class="form-group">
              <input type="text" id="memberNo" name="memberNo" placeholder=" " autocomplete="off">
              <label for="memberNo">Member No.</label>
            </div>
            <button type="submit" class="submit-btn">Start Chat</button>
          </form>
        </div>
      `;
        document
          .getElementById("contactForm")
          .addEventListener("submit", handleFormSubmit);
      }

      function renderChat() {
        mainContent.innerHTML = `
    <div class="chat-content" style="display:flex;">
      <div class="form-logo">
        <img src="images/header-bot.svg" alt="Bot">
      </div>

      <div class="chat-messages-container" id="chat-messages"></div>

      <div class="chat-options" id="chat-options">
        <button class="chat-option-btn" onclick="handleChatOption('Resort Info')">Resort Info</button>
        <button class="chat-option-btn" onclick="handleChatOption('AI Help')">AI Help</button>
        <button class="chat-option-btn" onclick="handleChatOption('Other')">Other</button>
      </div>

      <div class="chat-footer" id="chat-footer" style="display:none;">
        <div class="chat-input-row">
          <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Type here...">
            <button class="chat-mic-btn" id="mic-btn" aria-pressed="false" onclick="toggleMic()">
              <img src="images/mic-icon.svg" alt="Mic">
            </button>
          </div>
          <button class="chat-send-btn" id="chat-send-btn" onclick="sendFromInput()">
            <img src="images/send-button.svg" alt="Send">
          </button>
        </div>
      </div>
    </div>
  `;
        addMessage(
          "bot",
          `Hey, ${
            userName || "there"
          }! <br>Select an option below to get started.`
        );
        toggleChatFooter(false);
      }

      function goBackToChat() {
        resetFlow();
        currentPage = "chat";
        renderApp();
        document.querySelector(".back-btn").style.display = "none";
        toggleChatFooter(false);
      }

      function renderInfoPage(option) {
        mainContent.innerHTML = `
    <div class="info-page">
      <div class="form-logo">
        <img src="images/header-bot.svg" alt="Bot">
      </div>
      <div class="chat-messages-container" id="chat-messages">
        <div class="message bot">
          <div class="bot-avatar">
            <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
          </div>
          <div class="message-bubble">
            <div class="message-text">Hey, ${
              userName || "there"
            }!<br>How can I help?</div>
          </div>
        </div>
        <div class="message user">
          <div class="message-bubble">
            <div class="message-text">${option}</div>
          </div>
        </div>
<div class="message bot">
  <div class="bot-avatar">
    <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
  </div>
  <div class="message-bubble">
    <div class="message-text">
      Hey, ${userName || "there"}!<br>${
          option === "Resort Info"
            ? "Please type the name of the resort you’re interested in."
            : option === "AI Help"
            ? "Ask me anything and I’ll try my best to help."
            : "Choose a link below."
        }
    </div>
  </div>
</div>

      </div>
      <div class="chat-footer" id="chat-footer" style="display:none;">
        <div class="chat-input-row">
          <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Type here...">
            <button class="chat-mic-btn" id="mic-btn" aria-pressed="false" onclick="toggleMic()">
              <img src="images/mic-icon.svg" alt="Mic">
            </button>
          </div>
          <button class="chat-send-btn" onclick="sendFromInput()">
            <img src="images/send-button.svg" alt="Send">
          </button>
        </div>
      </div>
    </div>
  `;
        document.querySelector(".back-btn").style.display = "flex";
      }

      const resortTextFiles = [
        "content/KARMA-BAYON.txt",
        "content/KARMA-BORGO-DI-COLLEOLI.txt",
        "content/KARMA-CHAKRA.txt",
        "content/KARMA-CHATEAU-DE-SAMARY.txt",
        "content/KARMA-FUSHI.txt",
        "content/KARMA-GOLDEN-CAMP.txt",
        "content/KARMA-HAVELI.txt",
        "content/KARMA-JIMBARAN.txt",
        "content/KARMA-KANDARA.txt",
        "content/KARMA-KARNAK.txt",
        "content/KARMA-LA-HERRIZA.txt",
        "content/KARMA-LAKE-OF-MENTEITH.txt",
        "content/KARMA-LAKEWOOD.txt",
        "content/KARMA-MARTAM-RETREAT.txt",
        "content/KARMA-MINOAN.txt",
        "content/KARMA-MUNNAR.txt",
        "content/KARMA-PANALEE.txt",
        "content/KARMA-REEF.txt",
        "content/KARMA-RESIDENCE-NORMANDE.txt",
        "content/KARMA-ROYAL-BOAT-LAGOON.txt",
        "content/KARMA-ROYAL-CANDIDASA.txt",
        "content/KARMA-ROYAL-HAATHI-MAHAL.txt",
        "content/KARMA-ROYAL-JIMBARAN.txt",
        "content/KARMA-ROYAL-MONTERIO.txt",
        "content/KARMA-ROYAL-PALMS.txt",
        "content/KARMA-ROYAL-SANUR.txt",
        "content/KARMA-SALFORDHALL.txt",
        "content/KARMA-SANCTUM-SOHO.txt",
        "content/KARMA-SEVEN-LAKES.txt",
        "content/KARMA-SITABANI.txt",
        "content/KARMA-SONG-HOAI.txt",
        "content/KARMA-SUNSHINE-VILLAGE.txt",
        "content/KARMA-UTOPIA.txt",
        "content/KARMA-VARUNA.txt",
        "content/LE-PREVERGER.txt",
        "content/PELIKANOS.txt",
      ];

      function addBotElement(element) {
        const chatMessagesDiv = document.getElementById("chat-messages");
        if (!chatMessagesDiv) return;
        const messageElement = document.createElement("div");
        messageElement.className = "message bot";
        messageElement.innerHTML = `
    <div class="bot-avatar">
      <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
    </div>
  `;
        messageElement.appendChild(element);
        chatMessagesDiv.appendChild(messageElement);
        const mainContent = document.getElementById("main-content");
        if (mainContent) mainContent.scrollTop = mainContent.scrollHeight;
      }

      function createMainMenuButton() {
        const btn = document.createElement("button");
        btn.className = "resorts-option-btn";
        btn.textContent = "Main Menu";
        btn.addEventListener("click", () => {
          resetFlow();
          currentPage = "chat";
          renderApp();
          toggleChatFooter(false);
        });
        return btn;
      }

      function showMainMenuOption() {
        const wrap = document.createElement("div");
        wrap.className = "resorts-options";
        wrap.appendChild(createMainMenuButton());
        addBotElement(wrap);
      }

      function addMessage(sender, text) {
        const chatMessagesDiv = document.getElementById("chat-messages");
        if (!chatMessagesDiv) return;

        if (sender === "bot") {
          const typing = document.createElement("div");
          typing.className = "message bot typing";
          typing.innerHTML = `
      <div class="bot-avatar">
        <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
      </div>
      <div class="message-bubble">
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    `;
          chatMessagesDiv.appendChild(typing);
          scrollChatToBottom();

          setTimeout(() => {
            typing.remove();
            const messageElement = document.createElement("div");
            messageElement.className = "message bot";
            messageElement.innerHTML = `
        <div class="bot-avatar">
          <img src="images/bot-avatar.svg" alt="Bot Avatar" style="width:32px;height:32px;">
        </div>
        <div class="message-bubble">
          <div class="message-text">${text}</div>
        </div>`;
            chatMessagesDiv.appendChild(messageElement);
            scrollChatToBottom();
          }, 1200);
        } else {
          const messageElement = document.createElement("div");
          messageElement.className = `message ${sender}`;
          messageElement.innerHTML = `
      <div class="message-bubble">
        <div class="message-text">${text}</div>
      </div>`;
          chatMessagesDiv.appendChild(messageElement);
          scrollChatToBottom();

          playNotificationSound();
        }
      }

      function playNotificationSound() {
        const audio = new Audio("sounds/mixkit-message-pop-alert-2354.mp3");
        audio.volume = 0.5;
        audio.play().catch((err) => {
          console.warn("Sound blocked until user interacts:", err);
        });
      }

      function formatGeminiResponse(text) {
        let formatted = text;

        formatted = formatted.replace(/```json[\s\S]*?```/gi, "");

        formatted = formatted.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        formatted = formatted.replace(/\*(.*?)\*/g, "<em>$1</em>");

        formatted = formatted.replace(
          /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
          `<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>`
        );

        formatted = formatted.replace(
          /(https?:\/\/[^\s)]+)(?![^<]*<\/a>)/g,
          `<a href="$1" target="_blank" rel="noopener noreferrer">Click here</a>`
        );

        if (/^(\*|•|-)/m.test(formatted)) {
          formatted = formatted.replace(/(?:\*|•|-)\s(.+)/g, "<li>$1</li>");
          formatted = "<ul>" + formatted + "</ul>";
        } else {
          formatted = formatted.replace(/\n/g, "<br>");
        }

        return formatted.trim();
      }

      async function loadResortsData() {
        const res = await fetch("/final.json");
        const data = await res.json();
        return data;
      }

      async function loadResortsText() {
        const res = await fetch("/karma-chatbot-haathi-mahal-content.txt");
        return await res.text();
      }

      function showResortButtons(resort) {
        if (!resort) return;

        const buttonBox = document.createElement("div");
        buttonBox.classList.add("resort-buttons");

        if (resort.booking_link?.url) {
          const bookBtn = document.createElement("button");
          bookBtn.classList.add("menu-btn", "book-btn");
          bookBtn.innerText = resort.booking_link.label || "Book Now";
          bookBtn.onclick = () => {
            window.open(resort.booking_link.url, "_blank");
          };
          buttonBox.appendChild(bookBtn);
        }

        if (resort.features && Array.isArray(resort.features)) {
          resort.features.forEach((feature) => {
            const btn = document.createElement("button");
            btn.classList.add("menu-btn", "feature-btn");
            btn.innerText = feature.title || feature.key;

            btn.onclick = () => {
              let msg = `<strong>${feature.title}</strong><br>${feature.description}`;
              if (feature.resort_link) {
                msg += `<br><a href="${feature.resort_link}" target="_blank">More Info</a>`;
              }
              addMessage("bot", msg);
            };

            buttonBox.appendChild(btn);
          });
        }

        const chatBox = document.getElementById("chat-messages");
        const lastBotMsg = chatBox.querySelector(".message.bot:last-of-type");
        if (lastBotMsg && lastBotMsg.parentNode) {
          lastBotMsg.parentNode.insertBefore(buttonBox, lastBotMsg.nextSibling);
        } else {
          chatBox.appendChild(buttonBox);
        }

        buttonBox.scrollIntoView({ behavior: "smooth" });
      }

      async function loadAllResortsText() {
        try {
          const texts = await Promise.all(
            resortTextFiles.map(async (file) => {
              const res = await fetch(file);
              if (!res.ok) {
                console.warn("Failed to load:", file);
                return "";
              }
              return await res.text();
            })
          );
          return texts.join("\n\n");
        } catch (err) {
          console.error("Error loading text files:", err);
          return "";
        }
      }

      function resetIdleTimer() {
        if (idleTimer) clearTimeout(idleTimer);

        if (waitingForUser) {
          idleTimer = setTimeout(showEndMenu, 15000);
        }
      }

      function botFinishedReply() {
        waitingForUser = true;
        resetIdleTimer();
      }

      function showEndMenu() {
        if (document.querySelector(".menu-buttons")) return;

        const messageEl = addMessage(
          "bot",
          "Is there anything else we can assist you with today?"
        );

        setTimeout(() => {
          const chatFooter = document.getElementById("chat-footer");
          if (chatFooter) chatFooter.style.display = "none";

          const menuDiv = document.createElement("div");
          menuDiv.classList.add("menu-buttons");

          const askBtn = document.createElement("button");
          askBtn.classList.add("menu-btn", "ask-btn");
          askBtn.innerText = "Yes";
          askBtn.onclick = () => {
            menuDiv.remove();
            if (chatFooter) chatFooter.style.display = "block";
            document.getElementById("chat-input").focus();
            waitingForUser = true;
            resetIdleTimer();
          };

          const endBtn = document.createElement("button");
          endBtn.classList.add("menu-btn", "end-btn");
          endBtn.innerText = "No";
          endBtn.onclick = () => {
            menuDiv.remove();
            addMessage(
              "bot",
              "Thank you for chatting with Karma Concierge. Have a great day!"
            );
            setTimeout(() => {
              resetFlow();
              currentPage = "chat";
              renderApp();
              toggleChatFooter(false);
            }, 2000);
          };

          menuDiv.appendChild(askBtn);
          menuDiv.appendChild(endBtn);

          if (messageEl && messageEl.parentNode) {
            messageEl.parentNode.insertBefore(menuDiv, messageEl.nextSibling);
          } else {
            document.getElementById("chat-messages").appendChild(menuDiv);
          }

          menuDiv.scrollIntoView({ behavior: "smooth" });

          waitingForUser = false;
        }, 1500);
      }

      document.addEventListener("input", (e) => {
        if (e.target.id === "chat-input") {
          if (idleTimer) clearTimeout(idleTimer);
        }
      });

      function resetIdleTimer() {
        if (idleTimer) clearTimeout(idleTimer);

        if (waitingForUser) {
          idleTimer = setTimeout(showEndMenu, 15000);
        }
      }

      async function askGeminiDirect(question) {
        try {
          const jsonData = await loadResortsData();
          const resortsText = await loadAllResortsText();

          const response = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-goog-api-key": "AIzaSyAlqt2rbbP6aNI5Hka7QZ6T0ta94jX2EeM",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: `You are a travel assistant for **Karma Group** resorts only.  

                        User asked: ${question}  

                        Here is a JSON list of official resorts and links.  
                        Here is additional text info about resorts:  
                        ${resortsText}  

                        ⚠️ IMPORTANT:
                        - Never reply with "I don’t know", "maybe", or uncertain wording.  
                        - If the user’s question is about discounts, loyalty points, or complex policies →  
                        ALWAYS respond with:  
                            "⚠️ For detailed assistance, please contact Karma Concierge."  
                        Then provide only phone & email from JSON.  
                        - Only show booking link/resort highlights if the user asked about availability or stays.  

                        ${JSON.stringify(jsonData.resorts, null, 2)}

                          ### Rules:
                          - Be concise, structured, and **confident**.  
                          - Strictly limit output to **10 lines max**.  
                          - Categories to use (if relevant):  
                            - Availability info  
                            - Contact options (mandatory if Concierge needed)  
                            - Booking link  
                            - Resort highlights
                          + - Never output JSON or code — respond only in plain text for the user.  
                          + - Do not repeat raw links or JSON keys. If needed, describe them in words.
                          
                          `,
                      },
                    ],
                  },
                ],
              }),
            }
          );

          const data = await response.json();
          // ### Rules:
          //                       - Be concise, structured, and **confident**.
          //                       - Strictly limit output to **10 lines max**.
          //                       - Categories to use (if relevant):
          //                         - Availability info
          //                         - Contact options (mandatory if Concierge needed)
          //                         - Booking link
          //                         - Resort highlights

          let answer =
            data?.candidates?.[0]?.content?.parts?.[0]?.text ||
            "⚠️ For detailed assistance, please contact Karma Concierge.";
          console.log(data, "ANSWER:", answer);

          const uncertainPatterns =
            /(i don’t know|maybe|not sure|uncertain|can't help)/i;
          if (uncertainPatterns.test(answer)) {
            answer =
              "⚠️ For detailed assistance, please contact Karma Concierge.";
          }

          addMessage("bot", formatGeminiResponse(answer));
          // botFinishedReply();

          setTimeout(() => {
            const resort = findResortByName(question);
            if (resort) {
              currentResort = resort;
              showResortButtons(resort);
            }
          }, 3000);

          // resetIdleTimer();
        } catch (e) {
          console.error("Error in askGeminiDirect:", e);
          addMessage("bot", "Sorry, there was an error connecting to the AI.");
        }
      }

      function sendFromInput() {
        const input = document.getElementById("chat-input");
        if (!input) return;

        const val = (input.value || "").trim();
        if (!val) return;

        addMessage("user", val);

        if (activeFlow === "resort") {
          if (!resortsList.length) {
            addMessage(
              "bot",
              "Loading resort data… please try again in a moment."
            );
            input.value = "";
            return;
          }

          const resort = findResortByName(val);
          if (resort) {
            // currentResort = resort;
            // currentStep = "feature";
            // showResortDetails(resort);
            // showResortFeatures(resort);
            askGeminiDirect(val);
          } else {
            askGeminiDirect(val);
          }

          input.value = "";
          return;
        }

        if (activeFlow === "ai") {
          askGeminiDirect(val);
          input.value = "";
          return;
        }

        addMessage("bot", "Please use the buttons above.");
        input.value = "";
      }

      function handleFormSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        userName = (data.name || "").trim();
        currentPage = "chat";
        renderApp();
      }

      function renderApp() {
        if (currentPage === "login") renderLoginForm();
        else if (currentPage === "chat") renderChat();
      }

      function handleChatOption(option) {
        addMessage("user", option);

        if (option === "Resort Info") {
          resetFlow();
          activeFlow = "resort";
          renderInfoPage(option);
          toggleChatFooter(true);
          scrollSoon(); // <— auto scroll
          return;
        }

        if (option === "AI Help") {
          resetFlow();
          activeFlow = "ai";
          renderInfoPage(option);
          toggleChatFooter(true);
          scrollSoon(); // <— auto scroll
          return;
        }

        if (option === "Other") {
          resetFlow();
          activeFlow = "other";
          renderInfoPage(option);
          toggleChatFooter(false);
          showTopOtherOptions();
          showMainMenuOption();
          return;
        }

        addMessage("bot", "Please choose an option above.");
      }

      function openExternalLink(url) {
        const normalized = /^https?:\/\//i.test(url) ? url : `https://${url}`;
        window.open(normalized, "_blank", "noopener");
      }

      function buildLimitedSiteLinksButtons(limit = 4) {
        const wrap = document.createElement("div");
        wrap.className = "resorts-options";

        const all = Object.values(siteLinks || {}).map(({ label, url }) => ({
          label,
          url,
        }));

        function render(showAll) {
          wrap.innerHTML = "";
          const items = showAll ? all : all.slice(0, limit);

          items.forEach(({ label, url }) => {
            const btn = document.createElement("button");
            btn.className = "resorts-option-btn";
            btn.textContent = label;
            btn.addEventListener("click", () => openExternalLink(url));
            wrap.appendChild(btn);
          });

          const trimmed = all.length > limit;

          if (!showAll && trimmed) {
            const more = document.createElement("button");
            more.className = "resorts-option-btn";
            more.textContent = MORE_OPTIONS_LABEL;
            more.addEventListener("click", () => {
              render(true);
              requestAnimationFrame(() => {
                scrollChatToBottom();
              });
            });
            wrap.appendChild(more);
          }

          if (showAll || !trimmed) {
            wrap.appendChild(createOthersButton());
          }
        }

        render(false);
        return wrap;
      }

      function showTopOtherOptions() {
        addBotElement(buildLimitedSiteLinksButtons(4));
      }

      function findResortByName(name) {
        if (!Array.isArray(resortsList) || !resortsList.length) return null;
        const q = name.toLowerCase().trim();

        let hit = resortsList.find((r) => (r.name || "").toLowerCase() === q);
        if (hit) return hit;

        hit = resortsList.find((r) => (r.name || "").toLowerCase().includes(q));
        if (hit) return hit;

        const parts = q.split(/\s+/).filter(Boolean);
        hit = resortsList.find((r) => {
          const n = (r.name || "").toLowerCase();
          return parts.every((p) => n.includes(p));
        });

        return hit || null;
      }

      document.addEventListener("DOMContentLoaded", () => {
        clearChatStorage();
        resetFlow();
        userName = "";
        messages = [];
        currentPage = "login";
        renderApp();

        document.addEventListener("keydown", (event) => {
          const input = document.getElementById("chat-input");
          if (input && event.key === "Enter") {
            event.preventDefault();
            sendFromInput();
          }
        });
      });

      function showResortDetails(resort) {
        let html = `<strong style="color:#8b6f3d;">${resort.name}</strong><br>`;
        if (resort.booking_link && resort.booking_link.Description) {
          html += `<p>${resort.booking_link.Description}</p>`;
        }
        if (resort.resort_link && resort.resort_link.url) {
          html += `<p><a href="${resort.resort_link.url}" target="_blank">Learn more</a></p>`;
        }
        addMessage("bot", html);
        //  showMainMenuOption();
      }

      function showFeatureDetails(featureKey) {
        const feature = (currentResort?.features || []).find(
          (f) => f.key === featureKey
        );
        if (!feature) {
          addMessage(
            "bot",
            "Sorry, I couldn't find that feature. Please try again."
          );
          //  showMainMenuOption();
          return;
        }

        const url =
          typeof feature.resort_link === "string"
            ? feature.resort_link
            : feature.resort_link?.url;
        const html = `
    <strong style="color:#8b6f3d;">${feature.title}</strong><br>
    ${feature.description ? `<p>${feature.description}</p>` : ""}
    ${url ? `<p><a href="${url}" target="_blank">Learn more</a></p>` : ""}
  `;
        addMessage("bot", html);

        addBotElement(makeFeatureButtons(currentResort, featureKey));
        //  showMainMenuOption();
      }

      function makeFeatureButtons(resort, excludeKey) {
        return buildLimitedFeatureButtons(resort, excludeKey, 4);
      }

      function showResortFeatures(resort) {
        const wrap = buildLimitedFeatureButtons(resort, null, 4);
        addBotElement(wrap);
      }

      function buildLimitedFeatureButtons(
        resort,
        excludeKey = null,
        limit = 4
      ) {
        const wrap = document.createElement("div");
        wrap.className = "resorts-options";

        const all = (resort.features || []).filter((f) => f.key !== excludeKey);

        function render(showAll) {
          wrap.innerHTML = "";
          const items = showAll ? all : all.slice(0, limit);

          items.forEach((f) => {
            const btn = document.createElement("button");
            btn.className = "resorts-option-btn";
            btn.textContent = f.title;
            btn.addEventListener("click", () => handleFeatureSelection(f.key));
            wrap.appendChild(btn);
          });

          const trimmed = all.length > limit;

          if (!showAll && trimmed) {
            const more = document.createElement("button");
            more.className = "resorts-option-btn";
            more.textContent = MORE_OPTIONS_LABEL;
            more.addEventListener("click", () => {
              render(true);
              requestAnimationFrame(() => {
                scrollChatToBottom();
              });
            });
            wrap.appendChild(more);
          }

          if (showAll || !trimmed) {
            wrap.appendChild(createOthersButton());
          }
        }

        render(false);
        return wrap;
      }

      function handleFeatureSelection(featureKey) {
        const exists = (currentResort?.features || []).some(
          (f) => f.key === featureKey
        );
        if (!exists) {
          addMessage(
            "bot",
            "Sorry, I couldn't find that feature. Please try again."
          );
          return;
        }
        showFeatureDetails(featureKey);
      }
    </script>
  </body>
</html>
